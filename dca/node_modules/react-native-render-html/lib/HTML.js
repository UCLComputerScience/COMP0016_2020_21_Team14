var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _react=_interopRequireWildcard(require("react"));var _propTypes=_interopRequireDefault(require("prop-types"));var _reactNative=require("react-native");var _HTMLStyles=require("./HTMLStyles");var _HTMLUtils=require("./HTMLUtils");var _HTMLDefaultStyles=require("./HTMLDefaultStyles");var _htmlparser=require("htmlparser2");var _deprecatedPropType=_interopRequireDefault(require("deprecated-prop-type"));var HTMLRenderers=_interopRequireWildcard(require("./HTMLRenderers"));var _jsxFileName="/home/jsamr/Programmation/react-native-render-html/src/HTML.js";function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=(0,_getPrototypeOf2.default)(Derived),result;if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2.default)(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return(0,_possibleConstructorReturn2.default)(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}var DEPREC_MSG="This prop will be removed in the v6 release. ";function sourceObjectsAreEqual(oldSource,newSource){return oldSource.uri===newSource.uri&&oldSource.html===newSource.html;}function sourceHasChange(oldProps,newProps){return oldProps.uri!==newProps.uri||oldProps.html!==newProps.html||oldProps.source!==newProps.source&&!sourceObjectsAreEqual(oldProps.source,newProps.source);}var HTML=function(_PureComponent){(0,_inherits2.default)(HTML,_PureComponent);var _super=_createSuper(HTML);function HTML(props){var _this;(0,_classCallCheck2.default)(this,HTML);_this=_super.call(this,props);_this.state={};_this.renderers=(0,_extends2.default)({},HTMLRenderers,_this.props.renderers||{});_this.mounted=false;_this.generateDefaultStyles(props.baseFontStyle);return _this;}(0,_createClass2.default)(HTML,[{key:"setStateSafe",value:function setStateSafe(){this.mounted&&this.setState.apply(this,arguments);}},{key:"componentDidMount",value:function componentDidMount(){this.mounted=true;this.registerDOM();}},{key:"componentWillUnmount",value:function componentWillUnmount(){this.mounted=false;}},{key:"componentDidUpdate",value:function componentDidUpdate(prevProps,prevState){var renderers=prevProps.renderers,baseFontStyle=prevProps.baseFontStyle,tagsStyles=prevProps.tagsStyles,classesStyles=prevProps.classesStyles,contentWidth=prevProps.contentWidth,computeEmbeddedMaxWidth=prevProps.computeEmbeddedMaxWidth;var shouldParseDOM=tagsStyles!==this.props.tagsStyles||classesStyles!==this.props.classesStyles||contentWidth!==this.props.contentWidth||computeEmbeddedMaxWidth!==this.props.computeEmbeddedMaxWidth||baseFontStyle!==this.props.baseFontStyle||this.state.dom!==prevState.dom;this.generateDefaultStyles(this.props.baseFontStyle);if(renderers!==this.props.renderers){this.renderers=(0,_extends2.default)({},HTMLRenderers,this.props.renderers||{});}if(sourceHasChange(prevProps,this.props)){this.registerDOM(this.props);}if(shouldParseDOM){this.parseDOM(this.state.dom,this.props);}}},{key:"registerDOM",value:function registerDOM(){var props,cb,html,uri,_ref,_ref$body,body,_ref$method,method,_ref$headers,headers,response,dom,_args=arguments;return _regenerator.default.async(function registerDOM$(_context){while(1){switch(_context.prev=_context.next){case 0:props=_args.length>0&&_args[0]!==undefined?_args[0]:this.props;cb=_args.length>1?_args[1]:undefined;html=props.html||(props.source?props.source.html:null);uri=props.uri||(props.source?props.source.uri:null);if(!html){_context.next=8;break;}this.setStateSafe({dom:html,loadingRemoteURL:false,errorLoadingRemoteURL:false});_context.next=35;break;case 8:if(!uri){_context.next=34;break;}_context.prev=9;_ref=props.source?props.source:{},_ref$body=_ref.body,body=_ref$body===void 0?null:_ref$body,_ref$method=_ref.method,method=_ref$method===void 0?"GET":_ref$method,_ref$headers=_ref.headers,headers=_ref$headers===void 0?{}:_ref$headers;_context.prev=11;this.setStateSafe({loadingRemoteURL:true,errorLoadingRemoteURL:false});_context.next=15;return _regenerator.default.awrap(fetch(uri,{body:body,method:method,headers:headers}));case 15:response=_context.sent;_context.next=18;return _regenerator.default.awrap(response.text());case 18:dom=_context.sent;this.setStateSafe({dom:dom,loadingRemoteURL:false});_context.next=26;break;case 22:_context.prev=22;_context.t0=_context["catch"](11);console.warn(_context.t0);this.setStateSafe({errorLoadingRemoteURL:true,loadingRemoteURL:false});case 26:_context.next=32;break;case 28:_context.prev=28;_context.t1=_context["catch"](9);console.warn("react-native-render-html","Couldn't fetch remote HTML from uri : "+uri);return _context.abrupt("return",false);case 32:_context.next=35;break;case 34:console.warn("react-native-render-html","Please provide the source.html or source.uri prop.");case 35:case"end":return _context.stop();}}},null,this,[[9,28],[11,22]],Promise);}},{key:"parseDOM",value:function parseDOM(dom){var _this2=this;var props=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.props;var _this$props=this.props,htmlParserOptions=_this$props.htmlParserOptions,decodeEntities=_this$props.decodeEntities,debug=_this$props.debug,onParsed=_this$props.onParsed;var parser=new _htmlparser.Parser(new _htmlparser.DomHandler(function(_err,ldom){var RNElements=_this2.mapDOMNodesTORNElements(ldom,false,props);if(onParsed){var alteredRNElements=onParsed(ldom,RNElements);if(alteredRNElements){RNElements=alteredRNElements;}}_this2.setStateSafe({RNNodes:_this2.renderRNElements(RNElements,"root",0,props)});if(debug){console.log("DOMNodes from htmlparser2",ldom);console.log("RNElements from render-html",RNElements);}}),(0,_extends2.default)({},htmlParserOptions,typeof decodeEntities==="boolean"?{decodeEntities:decodeEntities}:{}));parser.write(dom);parser.done();}},{key:"generateDefaultStyles",value:function generateDefaultStyles(){var baseFontStyle=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.props.baseFontStyle;this.defaultBlockStyles=(0,_HTMLDefaultStyles.generateDefaultBlockStyles)(baseFontStyle.fontSize||14);this.defaultTextStyles=(0,_HTMLDefaultStyles.generateDefaultTextStyles)(baseFontStyle.fontSize||14);}},{key:"childrenNeedAView",value:function childrenNeedAView(children){for(var i=0;i<children.length;i++){if(children[i].wrapper==="View"){return true;}}return false;}},{key:"wrapperHasTextChild",value:function wrapperHasTextChild(children){for(var i=0;i<children.length;i++){if(children[i].wrapper==="Text"){return true;}}return false;}},{key:"associateRawTexts",value:function associateRawTexts(children){for(var i=0;i<children.length;i++){var child=children[i];if(child.wrapper==="Text"&&_HTMLUtils.TEXT_TAGS_IGNORING_ASSOCIATION.indexOf(child.tagName)===-1&&children.length>1&&(!child.parent||_HTMLUtils.TEXT_TAGS_IGNORING_ASSOCIATION.indexOf(child.parent.name)===-1)){var wrappedTexts=[];for(var j=i;j<children.length;j++){var nextSibling=children[j];if(nextSibling.wrapper!=="Text"||_HTMLUtils.TEXT_TAGS_IGNORING_ASSOCIATION.indexOf(nextSibling.tagName)!==-1){break;}wrappedTexts.push(nextSibling);children[j]=false;}if(wrappedTexts.length){children[i]={attribs:{},children:wrappedTexts,nodeIndex:i,parent:child.parent,parentTag:child.parentTag,tagName:"textwrapper",wrapper:"Text"};}}}return children.filter(function(parsedNode){return parsedNode!==false&&parsedNode!==undefined;});}},{key:"mapDOMNodesTORNElements",value:function mapDOMNodesTORNElements(DOMNodes){var _this3=this;var parentTag=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var props=arguments.length>2&&arguments[2]!==undefined?arguments[2]:this.props;var allowWhitespaceNodes=props.allowWhitespaceNodes,ignoreNodesFunction=props.ignoreNodesFunction,ignoredTags=props.ignoredTags,alterNode=props.alterNode,alterData=props.alterData,alterChildren=props.alterChildren,tagsStyles=props.tagsStyles,classesStyles=props.classesStyles;var RNElements=DOMNodes.map(function(node,nodeIndex){var _node=node,children=_node.children,data=_node.data;if(ignoreNodesFunction&&ignoreNodesFunction(node,parentTag)===true){return false;}if(ignoredTags.map(function(tag){return tag.toLowerCase();}).indexOf(node.name&&node.name.toLowerCase())!==-1){return false;}if(alterNode){var alteredNode=alterNode(node);node=alteredNode||node;}var _node2=node,type=_node2.type,attribs=_node2.attribs,name=_node2.name,parent=_node2.parent;if(alterData&&data){var alteredData=alterData(node);data=alteredData||data;}if(alterChildren&&children){var alteredChildren=alterChildren(node);children=alteredChildren||children;}var strippedData=data&&data.replace(/\s/g,"");if(type==="text"){if((!strippedData||!strippedData.length)&&!allowWhitespaceNodes){return false;}if(node.parent&&node.parent.name&&_HTMLUtils.PREFORMATTED_TAGS.indexOf(node.parent.name)===-1){data=data.replace(/(\r\n|\n|\r)/gm,"");}return{wrapper:"Text",data:data,attribs:attribs||{},parent:parent,parentTag:parent&&parent.name,tagName:name||"rawtext",domNode:node,nodeIndex:nodeIndex};}if(type==="tag"){if(children){children=_this3.associateRawTexts(_this3.mapDOMNodesTORNElements(children,name));}var wrapper="View";if(_this3.childrenNeedAView(children)){wrapper="View";}else if(_this3.renderers[name]&&_this3.renderers[name].wrapper){wrapper=_this3.renderers[name].wrapper;}else if(_HTMLUtils.BLOCK_TAGS.indexOf(name.toLowerCase())!==-1){wrapper="View";}else if(_HTMLUtils.TEXT_TAGS.indexOf(name.toLowerCase())!==-1||_HTMLUtils.MIXED_TAGS.indexOf(name.toLowerCase())!==-1){wrapper="Text";}return{wrapper:wrapper,children:children,attribs:attribs,parent:parent,tagName:name,parentTag:parentTag,domNode:node,nodeIndex:nodeIndex};}}).filter(function(parsedNode){return parsedNode!==false&&parsedNode!==undefined;}).map(function(parsedNode,nodeIndex){var wrapper=parsedNode.wrapper,children=parsedNode.children,attribs=parsedNode.attribs,tagName=parsedNode.tagName;var firstChild=children&&children[0];if(firstChild&&children.length===1){if((attribs===firstChild.attribs||!firstChild.attribs)&&firstChild.wrapper===wrapper&&(tagName===firstChild.tagName||firstChild.tagName==="rawtext")){return(0,_extends2.default)({},parsedNode,{attribs:(0,_extends2.default)({},attribs,firstChild.attribs),data:firstChild.data,children:[],tagName:tagName,nodeIndex:nodeIndex});}}return(0,_extends2.default)({},parsedNode,{nodeIndex:nodeIndex});}).map(function(parsedNode,nodeIndex){var wrapper=parsedNode.wrapper,attribs=parsedNode.attribs,tagName=parsedNode.tagName,children=parsedNode.children;if(wrapper==="View"&&attribs&&_this3.wrapperHasTextChild(children)){var wrapperStyles=(0,_extends2.default)({},tagsStyles[tagName]||{},(0,_HTMLStyles.getElementClassStyles)(attribs,classesStyles),(0,_HTMLStyles.cssStringToObject)(attribs.style||""));var textChildrenInheritedStyles={};Object.keys(wrapperStyles).forEach(function(styleKey){if(_HTMLUtils.TextOnlyPropTypes.indexOf(styleKey)!==-1){textChildrenInheritedStyles[styleKey]=wrapperStyles[styleKey];delete wrapperStyles[styleKey];}});if(Object.keys(textChildrenInheritedStyles).length===0){return parsedNode;}parsedNode.attribs.style=(0,_HTMLStyles.cssObjectToString)(wrapperStyles);for(var i=0;i<children.length;i++){var child=children[i];var lwrapper=child.wrapper,lattribs=child.attribs;if(lwrapper==="Text"){if(!lattribs.style){child.attribs.style=(0,_HTMLStyles.cssObjectToString)(textChildrenInheritedStyles);}else{child.attribs.style=(0,_HTMLStyles.cssObjectToString)((0,_extends2.default)({},textChildrenInheritedStyles,(0,_HTMLStyles.cssStringToObject)(child.attribs.style)));}}}}return parsedNode;});return this.associateRawTexts(RNElements);}},{key:"renderRNElements",value:function renderRNElements(RNElements){var _this4=this;var parentWrapper=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"root";var parentIndex=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var props=arguments.length>3&&arguments[3]!==undefined?arguments[3]:this.props;var allowFontScaling=props.allowFontScaling,allowedStyles=props.allowedStyles,baseFontStyle=props.baseFontStyle,classesStyles=props.classesStyles,emSize=props.emSize,ignoredStyles=props.ignoredStyles,ptSize=props.ptSize,tagsStyles=props.tagsStyles,textSelectable=props.textSelectable,_props$defaultTextPro=props.defaultTextProps,_textStlye=_props$defaultTextPro.style,defaultTextProps=(0,_objectWithoutProperties2.default)(_props$defaultTextPro,["style"]);return RNElements&&RNElements.length?RNElements.map(function(element,index){var attribs=element.attribs,data=element.data,tagName=element.tagName,parentTag=element.parentTag,children=element.children,nodeIndex=element.nodeIndex,wrapper=element.wrapper,domNode=element.domNode;var Wrapper=wrapper==="Text"?_reactNative.Text:_reactNative.View;var key=wrapper+"-"+parentIndex+"-"+nodeIndex+"-"+tagName+"-"+index+"-"+parentTag;var convertedCSSStyles=attribs&&attribs.style?(0,_HTMLStyles.cssStringToRNStyle)(attribs.style,Wrapper===_reactNative.Text?_HTMLUtils.STYLESETS.TEXT:_HTMLUtils.STYLESETS.VIEW,{parentTag:tagName,emSize:emSize,ptSize:ptSize,ignoredStyles:ignoredStyles,allowedStyles:allowedStyles}):{};var childElements=children&&children.length?children.map(function(child,childIndex){return _this4.renderRNElements([child],wrapper,index,props);}):false;var renderersProps={};if(Wrapper===_reactNative.Text){renderersProps=(0,_extends2.default)({},defaultTextProps);if(typeof textSelectable==="boolean"){renderersProps.selectable=textSelectable;}if(typeof allowFontScaling==="boolean"){renderersProps.allowFontScaling=allowFontScaling;}}if(_this4.renderers[tagName]){var customRenderer=typeof _this4.renderers[tagName]==="function"?_this4.renderers[tagName]:_this4.renderers[tagName].renderer;if(!customRenderer||typeof customRenderer!=="function"){console.warn("Custom renderer for "+tagName+" supplied incorrectly. Please check out the docs.");return undefined;}return customRenderer(attribs,childElements,convertedCSSStyles,(0,_extends2.default)({},props,{parentWrapper:wrapper,parentTag:parentTag,nodeIndex:nodeIndex,parentIndex:parentIndex,key:key,data:data,transientChildren:children,domNode:domNode},renderersProps));}var classStyles=(0,_HTMLStyles.getElementClassStyles)(attribs,classesStyles);var textElement=data?_react.default.createElement(_reactNative.Text,(0,_extends2.default)({style:(0,_HTMLStyles.computeTextStyles)(element,{defaultTextStyles:_this4.defaultTextStyles,tagsStyles:tagsStyles,classesStyles:classesStyles,baseFontStyle:baseFontStyle,emSize:emSize,ptSize:ptSize,ignoredStyles:ignoredStyles,allowedStyles:allowedStyles})},renderersProps,{__self:_this4,__source:{fileName:_jsxFileName,lineNumber:663,columnNumber:13}}),data):false;var style=[!tagsStyles||!tagsStyles[tagName]?(Wrapper===_reactNative.Text?_this4.defaultTextStyles:_this4.defaultBlockStyles)[tagName]:undefined,tagsStyles?tagsStyles[tagName]:undefined,classStyles,convertedCSSStyles].filter(function(s){return s!==undefined;});return _react.default.createElement(Wrapper,(0,_extends2.default)({key:key,style:style},renderersProps,{__self:_this4,__source:{fileName:_jsxFileName,lineNumber:694,columnNumber:13}}),textElement,childElements);}):false;}},{key:"render",value:function render(){var _this$props2=this.props,allowFontScaling=_this$props2.allowFontScaling,customWrapper=_this$props2.customWrapper,remoteLoadingView=_this$props2.remoteLoadingView,remoteErrorView=_this$props2.remoteErrorView;var _this$state=this.state,RNNodes=_this$state.RNNodes,loadingRemoteURL=_this$state.loadingRemoteURL,errorLoadingRemoteURL=_this$state.errorLoadingRemoteURL;if(!RNNodes&&!loadingRemoteURL&&!errorLoadingRemoteURL){return null;}else if(loadingRemoteURL){return remoteLoadingView?remoteLoadingView(this.props,this.state):_react.default.createElement(_reactNative.View,{style:{flex:1,alignItems:"center"},__self:this,__source:{fileName:_jsxFileName,lineNumber:717,columnNumber:9}},_react.default.createElement(_reactNative.ActivityIndicator,{__self:this,__source:{fileName:_jsxFileName,lineNumber:718,columnNumber:11}}));}else if(errorLoadingRemoteURL){return remoteErrorView?remoteErrorView(this.props,this.state):_react.default.createElement(_reactNative.View,{style:{flex:1,alignItems:"center"},__self:this,__source:{fileName:_jsxFileName,lineNumber:725,columnNumber:9}},_react.default.createElement(_reactNative.Text,{allowFontScaling:allowFontScaling,style:{fontStyle:"italic",fontSize:16},__self:this,__source:{fileName:_jsxFileName,lineNumber:726,columnNumber:11}},"Could not load ",this.props.uri));}return customWrapper?customWrapper(RNNodes):_react.default.createElement(_reactNative.View,{style:this.props.containerStyle||{},__self:this,__source:{fileName:_jsxFileName,lineNumber:739,columnNumber:7}},RNNodes);}}]);return HTML;}(_react.PureComponent);exports.default=HTML;HTML.propTypes={allowWhitespaceNodes:_propTypes.default.bool,renderers:_propTypes.default.object.isRequired,ignoredTags:_propTypes.default.array.isRequired,ignoredStyles:_propTypes.default.array.isRequired,allowedStyles:_propTypes.default.array,htmlParserOptions:_propTypes.default.object,debug:_propTypes.default.bool.isRequired,listsPrefixesRenderers:_propTypes.default.object,ignoreNodesFunction:_propTypes.default.func,alterData:_propTypes.default.func,alterChildren:_propTypes.default.func,alterNode:_propTypes.default.func,tagsStyles:_propTypes.default.object,classesStyles:_propTypes.default.object,containerStyle:_propTypes.default.oneOfType([_propTypes.default.object,_propTypes.default.array]),customWrapper:_propTypes.default.func,onLinkPress:_propTypes.default.func,onParsed:_propTypes.default.func,computeEmbeddedMaxWidth:_propTypes.default.func,contentWidth:_propTypes.default.number,enableExperimentalPercentWidth:_propTypes.default.bool,imagesInitialDimensions:_propTypes.default.shape({width:_propTypes.default.number,height:_propTypes.default.number}),emSize:_propTypes.default.number.isRequired,ptSize:_propTypes.default.number.isRequired,baseFontStyle:_propTypes.default.object.isRequired,renderersProps:_propTypes.default.object,WebView:_propTypes.default.elementType,defaultTextProps:_propTypes.default.object,defaultWebViewProps:_propTypes.default.object,source:_propTypes.default.oneOfType([_propTypes.default.shape({uri:_propTypes.default.string.isRequired,method:_propTypes.default.string,headers:_propTypes.default.object,body:_propTypes.default.string}),_propTypes.default.shape({html:_propTypes.default.string.isRequired,baseUrl:_propTypes.default.string})]),allowFontScaling:(0,_deprecatedPropType.default)(_propTypes.default.bool,DEPREC_MSG+'Use "defaultTextProps.allowFontScaling" prop instead.'),textSelectable:(0,_deprecatedPropType.default)(_propTypes.default.bool,DEPREC_MSG+'Use "defaultTextProps.textSelectable" prop instead.'),decodeEntities:(0,_deprecatedPropType.default)(_propTypes.default.bool,DEPREC_MSG+'Use "htmlParserOptions.decodeEntities" prop instead.'),html:(0,_deprecatedPropType.default)(_propTypes.default.string,DEPREC_MSG+'Use "source.html" prop instead.'),uri:(0,_deprecatedPropType.default)(_propTypes.default.string,DEPREC_MSG+'Use "source.uri" prop instead.')};HTML.defaultProps={allowWhitespaceNodes:false,renderers:HTMLRenderers,debug:false,emSize:14,ptSize:1.3,contentWidth:_reactNative.Dimensions.get("window").width,enableExperimentalPercentWidth:false,computeEmbeddedMaxWidth:function computeEmbeddedMaxWidth(contentWidth){return contentWidth;},ignoredTags:_HTMLUtils.IGNORED_TAGS,ignoredStyles:[],baseFontStyle:{fontSize:14},tagsStyles:{},classesStyles:{},onLinkPress:function onLinkPress(_e,href){return _reactNative.Linking.canOpenURL(href)&&_reactNative.Linking.openURL(href);},defaultTextProps:{allowFontScaling:true,selectable:false},htmlParserOptions:{decodeEntities:true},defaultWebViewProps:{}};